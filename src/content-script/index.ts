import ExpiryMap from 'expiry-map'
import 'github-markdown-css'
import Browser from 'webextension-polyfill'
import { captureEvent } from '../analytics'

const MSGTYPE_TEXT = 'MSGTYPE_TEXT'
const COPYRIGHT = 'Generated by GPT'
const GPT_RATELIMIT = 10
const HAS_RATELIMIT = false
const SHOW_COPYRIGHT = false

// æé—®æ¬¡æ•°é™åˆ¶
const cache = new ExpiryMap(30 * 60 * 1000)

function registerFileHelperHook(hook: string) {
  const script = hook + '.js'

  const s = document.createElement('script')
  s.type = 'text/javascript'
  s.src = Browser.runtime.getURL(script)
  s.async = true
  document.head.appendChild(s)
}

window.addEventListener(
  'filehelper:message:add',
  (e: any) => {
    console.info('Got a new @gpt message', e.detail)
    const { text } = e.detail

    // åˆ¤æ–­æ˜¯å¦æœ‰è§¦å‘å…³é”®è¯
    if (text) {
      if (HAS_RATELIMIT && !withRateLimitSatisfied("fileHelper")) {
        const response = {
          reply: 'æŠ±æ­‰ï¼Œä½ çš„æé—®å¤ªé¢‘ç¹äº†ï¼Œè¯·ç­‰ä¸€ä¼šå„¿å†æ¥é—®å§~',
        }
        reply(response)
        return
      }

      console.info(`ðŸ¤– Trigger GPT: ${text}`)
      const port = Browser.runtime.connect()
      const listener = (response: any) => {
        if (response && response.reply) {
          reply(response)
          captureEvent('chatgpt:response:success', { ...response })
        } else if (response.error) {
          response.reply = `æŠ±æ­‰ï¼ŒChatGPTæœåŠ¡å¼‚å¸¸ï¼Œé”™è¯¯ä»£ç ï¼š${response.error}ï¼Œè¯·è”ç³»å¼€å‘è€…çœ‹çœ‹ https://aow.me`
          reply(response)
          captureEvent('chatgpt:response:error', { ...response })
        } else {
          console.error('Call ChatGPT EXCEPTION')
        }
      }
      port.onMessage.addListener(listener)
      port.postMessage({
        question: text,
      })
      return () => {
        port.onMessage.removeListener(listener)
        port.disconnect()
      }
    }
  },
  false,
)

function withRateLimitSatisfied(actualSender: string) {
  const count = cache.get(actualSender) || 0

  if (count < GPT_RATELIMIT) {
    cache.set(actualSender, count + 1)
    return true
  }

  return false
}

function reply(response: any) {
  console.info('ðŸ˜€ ChatGPT response: ', response)

  let content = response.reply
  // æ˜¯å¦ç¾¤ç»„æ¶ˆæ¯
  if (SHOW_COPYRIGHT) {
    content = `${content}\n${COPYRIGHT}`
  }

  const msg = {
    MsgTypeText: MSGTYPE_TEXT,
    Content: content,
  }

  const event = new CustomEvent('filehelper:message:gpt_reply', {
    detail: msg,
  })

  window.dispatchEvent(event)
}

console.log('DOM loaded and register fileHelper hook.')
registerFileHelperHook('hook')
